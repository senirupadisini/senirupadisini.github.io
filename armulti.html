<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body { margin: 0; overflow: hidden; background: black; }
      a-scene, canvas { width: 100vw !important; height: 100vh !important; position: fixed !important; top: 0 !important; left: 0 !important; }
      #ar-camera-permission {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; color: white; display: flex; justify-content: center;
        align-items: center; text-align: center; z-index: 1000;
        font-family: sans-serif; font-size: 1.2em; cursor: pointer;
        padding: 20px; box-sizing: border-box;
      }
      #error-msg {
        display: none;
        position: absolute; bottom: 20px; left: 0; width: 100%;
        text-align: center; color: red; font-family: sans-serif;
        font-size: 0.9em; z-index: 2000; padding: 0 10px;
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <div id="ar-camera-permission">
      <div style="font-size:5.3em; font-weight:bold; margin-bottom:10px;">Ketuk untuk memulai AR dan izinkan akses kamera</div>
    <div id="error-msg"></div>

    <a-scene mindar-image="imageTargetSrc: https://senirupadisini.github.io/multitargets.mind; autoStart: false;"
             color-space="sRGB"
             renderer="colorManagement: true, physicallyCorrectLights"
             vr-mode-ui="enabled: false"
             device-orientation-permission-ui="enabled: false">

      <a-assets>
        <!-- Audio -->
        <audio id="audio-lim"  src="https://senirupadisini.github.io/audio_lim_kwi_bing.mp3"  preload="auto"></audio>
        <audio id="audio-ong"  src="https://senirupadisini.github.io/audio_ong_kian_bie.mp3"   preload="auto"></audio>

        <!-- Video -->
        <video id="video-widagdo" src="https://senirupadisini.github.io/video_widagdo.mp4"
               playsinline webkit-playsinline loop preload="auto" crossorigin="anonymous"></video>
        <video id="video-does"    src="https://senirupadisini.github.io/video_does.mp4"
               playsinline webkit-playsinline loop preload="auto" crossorigin="anonymous"></video>

        <!-- 3D Models (preloaded via asset) -->
        <a-asset-item id="model-tlp" src="https://senirupadisini.github.io/model_tan_liep_poen.glb"></a-asset-item>
        <a-asset-item id="model-kkb" src="https://senirupadisini.github.io/model_kho_khiem_bing.glb"></a-asset-item>
		
		<!-- Audio untuk 3D model -->
        <audio id="audio-tlp" src="https://senirupadisini.github.io/audio_tan_liep_poen.mp3" preload="auto"></audio>
        <audio id="audio-kkb" src="https://senirupadisini.github.io/audio_kho_khiem_bing.mp3" preload="auto"></audio>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Index 0: LKB → AUDIO -->
       <a-entity mindar-image-target="targetIndex: 0">
        <a-image src="https://senirupadisini.github.io/lim_kwi_bing_marker.jpg" position="0 0 0" width="1" height="1"></a-image>
      </a-entity>
	  
      <!-- Index 1: Ong Kian Bie → AUDIO -->
	   <a-entity mindar-image-target="targetIndex: 1">
        <a-image src="https://senirupadisini.github.io/OngKian_Bie_marker.jpg" position="0 0 0" width="1" height="1"></a-image>
      </a-entity>
	  
     <!-- Index 2: Kho Khiem Bing → 3D GLB -->
      <a-entity mindar-image-target="targetIndex: 2">
        <a-gltf-model src="#model-kkb" position="0 0 0" scale="0.80 0.80 0.80" rotation="0 0 0"></a-gltf-model>
      </a-entity>
     
      <!-- Index 3: Tan Liep Poen → 3D GLB -->
      <a-entity mindar-image-target="targetIndex: 3">
        <a-gltf-model src="#model-tlp" position="0 0 0" scale="0.90 0.90 0.90" rotation="0 0 0"></a-gltf-model>
      </a-entity>
	  
	  <!-- Index 4: Widagdo → VIDEO -->
	  <a-entity mindar-image-target="targetIndex: 4">
        <a-video src="#video-widagdo" position="0 0 0" width="1" height="0.56" rotation="0 0 0"></a-video>
      </a-entity>

      <!-- Index 5: Does → VIDEO -->
	   <a-entity mindar-image-target="targetIndex: 5">
        <a-video src="#video-does" position="0 0 0" width="1" height="0.56" rotation="0 0 0"></a-video>
      </a-entity>
	  	  
      
    </a-scene>

    <script>
      const sceneEl = document.querySelector('a-scene');
      const arCameraPermission = document.getElementById('ar-camera-permission');
      const errorMsg = document.getElementById('error-msg');
      const unmuteBtn = document.getElementById('unmute-btn');

      // Audio elements
      const audioLim = document.getElementById('audio-lim');
      const audioOng = document.getElementById('audio-ong');

      // Video elements
      const videoWidagdo = document.getElementById('video-widagdo');
      const videoDoes    = document.getElementById('video-does');

      // Track playing state per target
      const audioPlaying = { 4: false, 5: false };
      let activeVideo = null;

      // Tombol unmute — browser mobile butuh interaksi user untuk suara
      unmuteBtn.addEventListener('click', () => {
        if (activeVideo) {
          activeVideo.muted = false;
          activeVideo.play().catch(e => console.error(e));
        }
        unmuteBtn.style.display = 'none';
      });

      function showError(msg) {
        errorMsg.style.display = 'block';
        errorMsg.textContent = msg;
        console.error(msg);
      }

      async function startAR() {
        try {
          await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        } catch (err) {
          showError("Akses kamera ditolak. Mohon izinkan akses kamera di pengaturan browser.");
          return;
        }
        arCameraPermission.style.display = 'none';
        try {
          await sceneEl.systems['mindar-image-system'].start();
          console.log("MindAR started.");
        } catch (err) {
          showError("Gagal memulai AR: " + err.message);
        }
      }

      sceneEl.addEventListener('loaded', () => {
        arCameraPermission.addEventListener('click', startAR);
      });

      sceneEl.addEventListener('arReady', () => console.log("MindAR is ready!"));
      sceneEl.addEventListener('arError', (e) => showError("AR Error: " + (e.detail || "Unknown error")));

      // ── TARGET 0: Widagdo → Video ──
      const t0 = document.querySelectorAll('[mindar-image-target]')[4];
      t0.addEventListener('targetFound', () => {
        activeVideo = videoWidagdo;
        videoWidagdo.muted = true; // mulai muted dulu agar autoplay berhasil
        videoWidagdo.play().catch(e => console.error(e));
        unmuteBtn.style.display = 'block';
      });
      t0.addEventListener('targetLost', () => {
        videoWidagdo.pause();
        videoWidagdo.currentTime = 0;
        activeVideo = null;
        unmuteBtn.style.display = 'none';
      });

      // ── TARGET 1: Does → Video ──
      const t1 = document.querySelectorAll('[mindar-image-target]')[5];
      t1.addEventListener('targetFound', () => {
        activeVideo = videoDoes;
        videoDoes.muted = true;
        videoDoes.play().catch(e => console.error(e));
        unmuteBtn.style.display = 'block';
      });
      t1.addEventListener('targetLost', () => {
        videoDoes.pause();
        videoDoes.currentTime = 0;
        activeVideo = null;
        unmuteBtn.style.display = 'none';
      });

      // ── TARGET 2: Lim Kwi Bing → Audio ──
      const t2 = document.querySelectorAll('[mindar-image-target]')[0];
      t2.addEventListener('targetFound', () => {
        if (!audioPlaying[0]) {
          audioLim.play().catch(e => console.error(e));
          audioPlaying[0] = true;
        }
      });
      t2.addEventListener('targetLost', () => {
        audioLim.pause();
        audioLim.currentTime = 0;
        audioPlaying[0] = false;
      });

      // ── TARGET 3: Ong Kian Bie → Audio ──
      const t3 = document.querySelectorAll('[mindar-image-target]')[1];
      t3.addEventListener('targetFound', () => {
        if (!audioPlaying[1]) {
          audioOng.play().catch(e => console.error(e));
          audioPlaying[1] = true;
        }
      });
      t3.addEventListener('targetLost', () => {
        audioOng.pause();
        audioOng.currentTime = 0;
        audioPlaying[1] = false;
      });
  // ── TARGET 3 & 4: 3D GLB + Audio ──
      const t4 = document.querySelectorAll('[mindar-image-target]')[3];
      t4.addEventListener('targetFound', () => {
        audioTlp.play().catch(e => console.error(e));
      });
      t4.addEventListener('targetLost', () => {
        audioTlp.pause();
        audioTlp.currentTime = 0;
      });

      const t5 = document.querySelectorAll('[mindar-image-target]')[4];
      t5.addEventListener('targetFound', () => {
        audioKkb.play().catch(e => console.error(e));
      });
      t5.addEventListener('targetLost', () => {
        audioKkb.pause();
        audioKkb.currentTime = 0;
      });
      // ── TARGET 4 & 5: 3D GLB — tidak perlu event khusus, tampil otomatis ──
    </script>
  </body>
</html>
