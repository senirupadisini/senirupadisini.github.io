<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body { margin: 0; overflow: hidden; background: black; }
      a-scene, canvas { width: 100vw !important; height: 100vh !important; position: fixed !important; top: 0 !important; left: 0 !important; }
      
      #start-screen {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; color: white; display: flex; flex-direction: column;
        justify-content: center; align-items: center; text-align: center;
        z-index: 1000; font-family: sans-serif; padding: 20px; box-sizing: border-box;
      }
      #start-btn {
        margin-top: 30px; padding: 14px 36px; font-size: 1.1em;
        background: white; color: black; border: none; border-radius: 30px;
        cursor: pointer; font-weight: bold;
      }
      #loading-screen {
        display: none;
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        background: black; color: white; flex-direction: column;
        justify-content: center; align-items: center; text-align: center;
        z-index: 1000; font-family: sans-serif; padding: 20px; box-sizing: border-box;
      }
      .spinner {
        width: 50px; height: 50px; border: 5px solid #444;
        border-top-color: white; border-radius: 50%;
        animation: spin 1s linear infinite; margin-bottom: 20px;
      }
      @keyframes spin { to { transform: rotate(360deg); } }
      #loading-text { font-size: 1em; color: #ccc; margin-top: 10px; }
      
      #error-msg {
        display: none;
        position: absolute; bottom: 20px; left: 0; width: 100%;
        text-align: center; color: red; font-family: sans-serif;
        font-size: 0.9em; z-index: 2000; padding: 0 10px; box-sizing: border-box;
      }
      #sound-btn {
        display: none;
        position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.6); color: white; border: 2px solid white;
        border-radius: 30px; padding: 10px 24px; font-size: 1em;
        font-family: sans-serif; cursor: pointer; z-index: 2000; white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <!-- Layar awal -->
    <div id="start-screen">
      <div style="font-size:1.3em; font-weight:bold; margin-bottom:10px;">ðŸ“· AR Seni Rupa</div>
      <div style="font-size:0.95em; color:#ccc;">Arahkan kamera ke marker untuk melihat konten AR</div>
      <button id="start-btn">Mulai AR</button>
    </div>

    <!-- Layar loading -->
    <div id="loading-screen">
      <div class="spinner"></div>
      <div style="font-size:1.1em;">Memuat AR...</div>
      <div id="loading-text">Mohon tunggu sebentar</div>
    </div>

    <div id="error-msg"></div>
    <button id="sound-btn">ðŸ”Š Ketuk untuk aktifkan suara</button>

    <a-scene mindar-image="imageTargetSrc: https://senirupadisini.github.io/multitargets.mind; autoStart: false;"
             color-space="sRGB"
             renderer="colorManagement: true, physicallyCorrectLights"
             vr-mode-ui="enabled: false"
             device-orientation-permission-ui="enabled: false">

      <a-assets timeout="30000">
        <audio id="audio-lim" src="https://senirupadisini.github.io/audio_lim_kwi_bing.mp3" preload="auto"></audio>
        <audio id="audio-ong" src="https://senirupadisini.github.io/audio_ong_kian_bie.mp3" preload="auto"></audio>
        <audio id="audio-tlp" src="https://senirupadisini.github.io/audio_tan_liep_poen.mp3" preload="auto"></audio>
        <audio id="audio-kkb" src="https://senirupadisini.github.io/audio_kho_khiem_bing.mp3" preload="auto"></audio>

        <video id="video-widagdo" src="https://senirupadisini.github.io/video_widagdo.mp4"
               playsinline webkit-playsinline loop preload="auto" crossorigin="anonymous"></video>
        <video id="video-does" src="https://senirupadisini.github.io/video_does.mp4"
               playsinline webkit-playsinline loop preload="auto" crossorigin="anonymous"></video>

        <a-asset-item id="model-tlp" src="https://senirupadisini.github.io/model_tan_liep_poen.glb"></a-asset-item>
        <a-asset-item id="model-kkb" src="https://senirupadisini.github.io/model_kho_khiem_bing.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Index 0: Lim Kwi Bing â†’ AUDIO -->
      <a-entity mindar-image-target="targetIndex: 0">
        <a-image src="https://senirupadisini.github.io/im_kwi_bing_marker.jpg" position="0 0 0" width="1" height="1"></a-image>
      </a-entity>

      <!-- Index 1: Ong Kian Bie â†’ AUDIO -->
      <a-entity mindar-image-target="targetIndex: 1">
        <a-image src="https://senirupadisini.github.io/OngKian_Bie_marker.jpg" position="0 0 0" width="1" height="1"></a-image>
      </a-entity>

      <!-- Index 2: Kho Khiem Bing â†’ 3D + Audio -->
      <a-entity mindar-image-target="targetIndex: 2">
        <a-gltf-model src="#model-kkb" position="0 0 0" scale="0.80 0.80 0.80" rotation="0 0 0"></a-gltf-model>
      </a-entity>

      <!-- Index 3: Tan Liep Poen â†’ 3D + Audio -->
      <a-entity mindar-image-target="targetIndex: 3">
        <a-gltf-model src="#model-tlp" position="0 0 0" scale="0.90 0.90 0.90" rotation="0 0 90"></a-gltf-model>
      </a-entity>

      <!-- Index 4: Widagdo â†’ VIDEO -->
      <a-entity mindar-image-target="targetIndex: 4">
        <a-video src="#video-widagdo" position="0 0 0" width="1" height="0.56" rotation="0 0 0"></a-video>
      </a-entity>

      <!-- Index 5: Does â†’ VIDEO -->
      <a-entity mindar-image-target="targetIndex: 5">
        <a-video src="#video-does" position="0 0 0" width="1" height="0.56" rotation="0 0 0"></a-video>
      </a-entity>

    </a-scene>

    <script>
      const sceneEl = document.querySelector('a-scene');
      const startScreen = document.getElementById('start-screen');
      const loadingScreen = document.getElementById('loading-screen');
      const loadingText = document.getElementById('loading-text');
      const errorMsg = document.getElementById('error-msg');
      const soundBtn = document.getElementById('sound-btn');
      const startBtn = document.getElementById('start-btn');

      const audioLim = document.getElementById('audio-lim');
      const audioOng = document.getElementById('audio-ong');
      const audioTlp = document.getElementById('audio-tlp');
      const audioKkb = document.getElementById('audio-kkb');
      const videoWidagdo = document.getElementById('video-widagdo');
      const videoDoes = document.getElementById('video-does');

      let pendingPlay = null;

      soundBtn.addEventListener('click', () => {
        if (pendingPlay) { pendingPlay(); pendingPlay = null; }
        soundBtn.style.display = 'none';
      });

      function playAudio(audio) {
        audio.play().then(() => {
          soundBtn.style.display = 'none';
        }).catch(() => {
          pendingPlay = () => audio.play().catch(e => console.error(e));
          soundBtn.style.display = 'block';
        });
      }

      function stopAudio(audio) {
        audio.pause(); audio.currentTime = 0;
        soundBtn.style.display = 'none'; pendingPlay = null;
      }

      function playVideo(video) {
        video.muted = true;
        video.play().catch(e => console.error(e));
        pendingPlay = () => { video.muted = false; video.play().catch(e => console.error(e)); };
        soundBtn.style.display = 'block';
      }

      function stopVideo(video) {
        video.pause(); video.currentTime = 0;
        soundBtn.style.display = 'none'; pendingPlay = null;
      }

      function showError(msg) {
        loadingScreen.style.display = 'none';
        errorMsg.style.display = 'block';
        errorMsg.textContent = msg;
        console.error(msg);
      }

      // Tombol Mulai AR
      startBtn.addEventListener('click', async () => {
        // Minta izin kamera
        try {
          await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        } catch (err) {
          showError("Akses kamera ditolak. Izinkan kamera di pengaturan browser.");
          return;
        }

        // Tampilkan loading
        startScreen.style.display = 'none';
        loadingScreen.style.display = 'flex';
        loadingText.textContent = 'Memuat file AR... (bisa 10-30 detik)';

        try {
          await sceneEl.systems['mindar-image-system'].start();
          loadingScreen.style.display = 'none';
          console.log("MindAR started.");
        } catch (err) {
          showError("Gagal memulai AR: " + err.message);
        }
      });

      sceneEl.addEventListener('arReady', () => {
        loadingScreen.style.display = 'none';
        console.log("MindAR is ready!");
      });

      sceneEl.addEventListener('arError', (e) => showError("AR Error: " + (e.detail || "Unknown")));

      const targets = document.querySelectorAll('[mindar-image-target]');

      targets[0].addEventListener('targetFound', () => playAudio(audioLim));
      targets[0].addEventListener('targetLost',  () => stopAudio(audioLim));

      targets[1].addEventListener('targetFound', () => playAudio(audioOng));
      targets[1].addEventListener('targetLost',  () => stopAudio(audioOng));

      targets[2].addEventListener('targetFound', () => playAudio(audioKkb));
      targets[2].addEventListener('targetLost',  () => stopAudio(audioKkb));

      targets[3].addEventListener('targetFound', () => playAudio(audioTlp));
      targets[3].addEventListener('targetLost',  () => stopAudio(audioTlp));

      targets[4].addEventListener('targetFound', () => playVideo(videoWidagdo));
      targets[4].addEventListener('targetLost',  () => stopVideo(videoWidagdo));

      targets[5].addEventListener('targetFound', () => playVideo(videoDoes));
      targets[5].addEventListener('targetLost',  () => stopVideo(videoDoes));

    </script>
  </body>
</html>
